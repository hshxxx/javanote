# 计算机网络

## 0. 概述

- 因特网的边缘部分和核心部分的作用，包含分组交换的概念
- 计算机网络的一些性能指标
- 计算机网络分层次的体系结构，包含协议和服务的概念

### 0.1 因特网的组成

- 因特网 = 边缘部分 + 核心部分
  - 边缘部分：由许多主机组成，面向用户
    - 两种通信方式：客户服务器模式 ， 端到端P2P模式
  - 核心部分：由许多网络和路由器组成，为边缘部分提供服务，**路由器**是实现**分组交换**的关键
    - 电路交换：建立连接（占用通信资源） -->通话（一直占用）-->释放连接（释放资源）；
    - 分组交换：将报文分割成若干分组，路由器对分组进行存储转发，**分片是在分组的基础上**
      - 虚电路：面向连接**的通信服务，两个节点或应用进程**之间建立起一个**逻辑上**的连接或虚电路后，接收端收到分组的顺序与发送端的发送顺序一致，因此无须在接收分组后重新进行排序。一条物理线路上可以有多个虚电路， 虚电路是网络层向传输层提供的一种服务 
- 计算机网络的性能
  - 速率：数字信道上传送数据的**额定速率**，如b/s（比特每秒），通俗的用100M以太网，省略了/s
  - 带宽：
    - 带宽本来的意思：某个信号具有的**频带宽度**，信号的带宽值该信号所包含的**各种不同频率成**分所占据的**频率范围**，如3.1kHz表示该线路上信号的频率从0到3.1kHz
    - 计算机网络中的意思：网络带宽表示在**单位时间内**从网络中**点到点**所能通过的**最高数据率**，单位是b/s，kb/s等，带宽越高说明最高数据率越高，所传输的数据也越多
  - 吞吐量：单位时间内通过某个网络，信道或接口的数据量，数据量也可以用字节，帧数来衡量。一个100M/S的以太网，典型的吞吐量也就是70M/S
  - 时延
    - 发送（传输）时延：**数据帧长度 / 发送速率** ，指**一个站点从开始发送数据帧到数据帧发送完毕**所需要的全部时间
    - 传播时延：**信道长度 / 电磁波在信道上传播速率**，指**发送端开始发送数据到接收端收到**数据所需要的全部时间
    - 总时延 = 发送时延 + 传播时延 + 处理时延 + 排队时延
    - 电磁信号传输1km，用5微妙
  - 时延带宽积 = 传播时延 × 带宽
  - 往返时间RTT：指**从发送方发送数据开始，到发送方收到确认**
  - 利用率
    - **信道利用率**：某信道多长时间内有百分之几的时间内被利用，信道利用率太高信道时延增加，容易发生堵塞
    - **网络利用率**：全网络的**信道利用率的加权平均值**，网络利用率达到一半时，时延就要加倍
- 计算机网络体系结构
  - OSI的七层协议中的**物理层和数据链路层**在TCP/IP协议中统称为**网络接口层**；
  - OSI的七层协议中的**会话层，表示层和应用层**在TCP/IP协议中统称为**应用层**



## 1、物理层

- 物理层的任务
- 几种常用信道复用技术
- 几种常用的宽带接入技术

### 1.1 数据通信

- 信号：通信的目的是传送文字，图像，视频等**消息**，**数据**是运送**消息的实体**，通常是有意义的符号序列，而**信号**则是**数据**的电气或电磁的表现
  - 模拟信号 或 连续信号 代表消息的参数的取值是连续的
  - 数字信号 或 离散信号 代表消息的参数的取值是离散的
    - 码元：代表不同离散数值的基本波形就称为码元
- 信道的类型
  - 单工通信：只能有一个方向的通信
  - 半双工通信：双方都可以通信，但双方不能同时发送和接收信息
  - 全双工通信：双方都可以通信，双发可以同时发送和接收信息
- 调制：
  - 基带信号：来自信源的信号成为基带信号，计算机输出的数据信号也属于基带信号，基带信号**多含低频信号**，但许多信道并不能传输这种低频信号，所以需要**调制**
  - 调制的分类
    - **基带调制**：仅对基带信号的波形进行变换，使其能与信道特性相适应，这种过程也叫**编码**
    - **带通调制**：把基带信号的频率范围迁移到更高的频段，并转换成模拟信号
  - 编码方式
    - 不归零制：正电平代表1，负电平代表0
    - 归零制：正脉冲代表1，负脉冲代表0
    - 曼彻斯特：位周期**中心**向上跳变代表0，向下跳变代表1
    - 差分曼彻斯特：每一位的中心都有跳变，位开始**边界**有跳变代表0，没有跳变代表1
  - 带通调制方法
    - 调幅AM：0对应无载波输出，1对应有载波输出
    - 调频FM：0对应低频率，1对应高频率
    - 调相PM：0对应相位0度，1对应相位180度

### 1.2 物理层下的传输媒体

- 传输媒体分为 引导型和非引导型
  - 导引型：沿着固体媒体传输
  - 非导引型：无线传输
- 导引型
  - 双绞线：两根互相绝缘的铜导线互相缠绕着排放在一起，屏蔽双绞线STP，非屏蔽双绞线UTP
    - 3类：低速网络，模拟电话
    - 4类：短距离的10BAST-T以太网
    - 5类：10BAST-T以太网
    - 5E类：100BAST-T
    - 6类：1000BAST-T
    - 7类：STP
  - 同轴电缆
  - 光纤
    - 当光纤的直径减小到1个光的波长时，这样的光纤就称为单模光纤 

### 1.3 信道复用技术

- 最基本的复用：将多个用户的多个信号用**复用器收集**，经过高速通道传输，然后用**分用器分用**给用户
  - 频分复用FDM：所有用户在同样时间内占用不同的带宽（频率）资源。每个用户对应一个特有的频率
  - 时分复用TDM：所有用户在不同时间占用同样的频带宽度。信道被所有用户平分成独立的时间段
  - 统计时分复用STDM：使用**集中器**将使用TDM的用户的数据集中起来，统一发送，减少了TDM中没有使用的时间段
- 波分复用WDM：光的频分复用，只不过用的是**光的波长**而非频率
- 码分多址CDMA：每一个比特时间再划分成m个时间段称为**码片**，每一个使用CDMA的站被分配一个独有的码片，该站发送1，就发送自己的码片，发送0，就发送自己的码片的反码

### 1.4 宽带接入技术

- 非对称数字用户线ADSL：
  - 把低频分给电话，高频分给上网，因为下行远大于上行，所以叫做非对称
  - 用户需要利用**电话线**连接**调制解调器**连接到ISP
- 光纤同轴混合网HFC
- FTTx技术：光纤





- 集线器（HUB）： **连接许多站点，对接收到的信号进行再生整形放大**，以扩大网络的传输距离，同时把所有节点集中在以它为中心的节点上。 
- 中继器：是连接网络线路的一种装置，常用于**两个网络节点之间物理信号的双向转发工作**。中继器是最简单的网络互联设备，主要完成物理层的功能，负责在两个节点的物理层上按位传递信息，完成信号的复制、调整和放大功能，以此来延长网络的长度。 

## 2、链路层

- 数据链路层主要使用**点对点信道**和**广播信道**，了解这两个信道的特点和所使用**PPP协议**与**CSAD/CD协议**
- 三个基本问题：**封装成帧，透明传输，差错检测**
- **以太网MAC层的硬件地址**
- **适配器，转发器，集线器，网桥，以太网交换机**的作用和使用场合
- 局域网上的计算机被称为主机，工作站，站，站点等；以太网是总线型局域网
- 研究在同一个局域网内，不经过路由器，分组怎样实现一个主机传送到另一个主机



### 2.1 使用点对点信道的数据链路层

#### 2.1.1数据链路和帧

- **链路**和**数据链路**区别
  - 链路：结点A和相邻结点B之间的一段有线或无线的物理线路，结点间无其他结点
  - 数据链路：链路 + 实现了某些通信协议的软硬件
- 帧
  - 链路层传输数据的单位，帧 = 首部 + IP数据报 + 尾部
  - 把网络层传下来的数据构成帧发送，或把帧中的数据取出传给网络层

#### 2.1.2 三个基本问题

- 封装成帧：在一段数据前后加上首部和尾部构成一个帧
  - 首部和尾部的作用：确定帧的界限，添加控制信息
  - 每种**链路层协议**确定不同的帧中**数据部分**的最大长度---**最大传输单元MTU**
  - 帧定界符：7位ASCII码，利用键盘不能输入的33个控制字符
    - 首部控制字符： SOH ； 尾部控制字符：EOT ； 
    - 只有当收到SOH 和 EOT后才能确定这个帧完全收到
- 透明传输：解决数据中出现帧定界符问题
  - 某一个实际存在的事物却好像不存在一样---->通过技术手段来忽略数据中出现的“帧定界符”
    - 在数据中出现的 ”帧定界符“ 的**前面**加上**转义字符ESC**，在接收端准备送往网络层前删除转义字符ESC。-------称为**字节（符）填充**
  - 原本设置了帧定界符来确定一个完整的帧，但当所传数据中出现帧定界符时该方法失效，为了解决这个问题，提出转义字符ESC，ESC让所传数据中无意间凑出的“帧定界符”失效，这就叫透明传输，它忽略了不该出现但需要处理的对象。
- 差错检测：利用硬件实现，不延误数据传输
  - 发送端：循环冗余检验CRC + 帧检验序列FCS
    - 利用CRC技术，根据待传送的数据算出冗余码，然后将冗余码拼接在数据后形成FCS并发送
  - 接收端：循环冗余检验CRC
    - 利用CRC技术对传来的帧逆向检验，若余数为0则这个帧没有差错并接受，否则有差错则**丢弃**
  - 传输差错
    - 比特差错：0变1,1变0
    - 出现传输差错：帧丢失，帧重复，帧失序
  - **无差错接受**
    - 我们认为接收端接受的数据在传输过程中没有出现传输差错
  - **可靠传输**
    - 发送端发送什么，在接收端就接受什么
  - **若在数据链路层仅使用CRC检测技术，则只能做到无差错的传输，不能做到可靠传输**
    - 在有线传输链路上，数据链路层不使用确认重传机制，改错的任务由上层的协议完成
    - 在无线传输链路上，数据链路层使用确认重传机制，并**向上提供可靠传输的服务**

### 2.2 点对点协议PPP---点对点

#### 2.2.1 PPP协议需要满足的要求

- 简单：对链路层的帧不需要纠错，序号，只需要进行CRC检验，正确就留下，错误就丢弃。纠错交给TCP实现
- 在同一条物理链路上同时支持多种网络层协议
- 能在不同类型的点对点链路上运行（串行或并行的，点的或光的等等）
- 自动检测链路是否处于正常工作状态
- 对每一种点对点链路设置MTU的默认值，**数据部分的大小超过MTU的帧要丢弃**
- 不支持多点线路（一个主站轮流和链路上的多个从站进行通信上），**只支持点对点的链路**通行，同时**只支持全双工链路**

#### 2.2.2 PPP协议的帧格式

- PPP帧 = 首部（4个字段） + 数据部（不超过1500字节的IP数据报） + 尾部（2个字段）
- 字节填充：解决数据部出现帧定界符
- 零比特填充：解决数据部出现帧定界符，连续5个1后添加一个0位

#### 2.2.3 PPP协议的工作状态

- PPP链路的初始化
  - 链路静止--->用户PC拨号接入**ISP**，建立物理连接--->用户向ISP发送**链路控制协议LCP**分组，建立LCP连接---->**网络控制协议NCP**给用户分配一个临时IP地址-->通信完毕，NCP释放网络连接，收回IP地址--->LCP释放数据链路层连接--->释放物理层连接，链路静止

### 2.3 使用广播信道的数据链路层---一对多

 #### 2.3.1 适配器的作用

- 计算机 和 外界局域网 的连接通过通信适配器，适配器也叫**网卡**
- 适配器和计算机之间通过**I/O总线以并行传输方式**进行，因为网络上的和总线上的数据率不匹配所以适配器中设有数据**缓存区**，适配器接受和发送各种帧时不使用计算机CPU
- **适配器的ROM**中存储计算机的**硬件地址**，计算机的存储器存储计算机的软件地址---IP地址
- 路由器中的适配器相当于一个接口，若路由器身处两个网络那么就需要两个适配器两个物理地址
- 转发：
  - 单播帧：一对一
  - 广播帧：一对全体，发送给本局域网上所有站点的帧
  - 多播帧：一对多，发送给本局域网上一部分站点的帧

#### 2.3.2 CSMA/CD协议

- 以太网
  - 总线的特点：当一台计算机发送数据，所有总线上的计算机都能收到，是一种广播方式。
    - 同一时间只允许一台计算机发送数据，当发射冲突时，双方等待直到没人发送时再发送
  - 早期以太网中许多计算机都连接在一条主线上，为实现一对一的通信，每台计算机上的适配器有自己独有的地址，在发送帧时指定目标地址，适配器只会接受发给自己的帧
  - 采用无连接工作方式，数据帧不编号也不需要对方发回确认，提供不可靠传输，由上层协议决定是否重传
  - 采用**曼彻斯特编码**信号：当出现一连串0或1时接收端无法提取位同步，所以将0,1码元分成两个相等的间隔
    -  常用于局域网传输。曼彻斯特编码将时钟和数据包含在[数据流]中，在传输代码信息的同时，也将[**时钟同步]**信号一起传输到对方，每位编码中有一跳变，**不存在直流分量**，因此具有**自同步能力**和良好的**[抗干扰]**性能。但每一个[码元]都被调成两个电平，所以[数据传输速率]只有调制速率的1/2。 
- CSMA/CD协议
  - 多点接入：**总线型网络**，协议的实质时载波监听和碰撞检测
  - 载波监听：利用电子技术检测总线上有没有其他计算机也在发送，每个站在发送前，中都必须不停检测
  - 碰撞检测：适配器边发送边监听
    - 发送端最迟经过**两倍的端到端的传播时长**时检测到发生碰撞
    - 检测到碰撞时立即停止发送
  - 使用CSMA/AD协议时，一个站不能同时进行发送和接收，所以是**半双工通信**。
  - 发送的不确定性：发送端发送一段数据后的一小段时间不能保证是否遭遇碰撞，若在这小段时间内检测到碰撞，则刚发送的数据失效
  - 碰撞窗口（争用期）：发送数据后的一小段时间成为碰撞窗口，若这段时间内未检测到碰撞则肯定这次发送未发生碰撞
  - 截断二进制指数退避：发生碰撞后推迟一个随机的时间后再发送
  - 人为干扰信号：发生碰撞后发送端继续发送32或48比特的数据，目的是让所有用户都知道现在发生了碰撞

### 2.4 使用广播信道的以太网

#### 2.4.1 MAC层

- MAC 帧 = **目的地址字段 + 源地址字段 + 类型字段 + 数据字段 + 帧检验序列FCS**
  - 占48位，指局域网上的每一台计算机中固化在**适配器ROM中的地址**
  - 前三个字节由OUI分配，后三个字节由公司自己指派
  - 类型字段：标志上一层使用什么协议

### 2.5 扩展的以太网

#### 2.5.1数据链路层扩展以太网

- 网桥：工作在数据链路层，对MAC帧进行转发和过滤
  - 网桥中有多个**接口**，每个接口代表一个**以太网**，每个以太网可以称作一个**网段**
  -  **网桥能够互连两个采用不同数据链路层协议、不同传输介质与不同传输速率的以太网，**进而形成更大的以太网
  - **广播风暴**：网桥只适合用户数不超过几百个的以太网，否则会因为太多广播信息进而产生网络拥塞 
  - 网桥中有一张**转发表**（路由目录），每个表项记录**硬件地址和接口的映射关系**，跨以太网的帧通过该表确定将收到的帧如何转发。若发现收到的帧需要转发的接口还是帧所在接口，则丢弃该帧，因为同一个以太网内不需要网桥。
  - **不同网段**上的通信不会互相干扰，**隔离冲突域，但不会隔绝广播域**
  - 网桥在转发帧时**不改变帧的源地址**
- 透明网桥
  - 结构和网桥类似，，但**转发表为空**，即插即用，网桥根据**自学习算法**来丰富转发表，只要某个站发送过帧，那么转发表都会记录下来；同时转发表记录下帧进入的时间，以便及时更新
  - 若转发表中没有找到转发帧的目的地址所在接口，那么该帧将被转发到表中所有的接口上
  - **生成树算法**：互连在一起的网桥在进行彼此通信后，就能找出原来网络拓扑的一个子集，在这个子集里不存在回路，避免浪费资源。
- 源路由网桥---选出一个**最佳路径**
  - 源路由网桥在发送帧时将**详细的路由信息**放在**帧首部**，这个帧就按照规划好的路径传输
  - 源站以广播方式发送一个发现帧做探测，发现帧沿着所有可能的路由传输并**记录经过的路由**，直到到达目的站后原路返回，源站经过筛选确定最佳路径，之后**源站和目的站**之间的通信都使用这个确定好的路径
- 多接口网桥----以太网交换机
  - **接口数很多的透明网桥**，每个接口连接一个**主机**或另一个**集线器**，采用自学习算法
  - 交换机能够同时连通许多对接口，每一对相互通信的主机能够独立传输，互不影响
  - **虚拟局域网VLAN**：一些局域网**网段**构成的与物理位置无关的**逻辑组**，每个VLAN有标识符，指明某个帧所属的VLAN。每个VLAN中的工作站可以处在**不同的局域网中**，所以可以将跨网段的站点集中在一个VLAN中通信，每个VLAN中的站点可以收到同一个VLAN中其他成员的广播。



## 3、网络层

- **虚拟互连网络**的概念
- **IP地址与物理地址**的关系
- 传统的分类的**IP地址**（包括子网掩码）和**无分类域间路由选择CIDR**
- **路由选择协议**的工作原理、
- 因为网络上的端是计算机，具有较强的自我纠错能力，所以网络层向上只提供简单灵活的，**无连接**，**不可靠交付**的数据报服务。每个数据报独立发送，前后发送的分组无关。这也使网络的路由器做的简单，造价低廉。

### 3.1  网际协议IP

- 与IP配套的协议： **地址解析协议ARP  + 网际控制报文协议ICMP + 网际组管理协议IGMP**
- 中间设备：将网络互相连接起来的设备
  - 物理层：转发器
  - 链路层：网桥
  - 网络层：路由器
  - 网络层以上：网关
- **虚拟互连网络**：各种物理网络不尽相同，若所有网络使用相同的IP协议，那么网络之间通过路由器互联起来，在网络层上看起来就好像是统一的网络。虚拟互连网络就是有多种不同的网络互连组成。

#### 3.1.1 分类的IP地址

- 发展过程：分类的IP地址---->子网的划分----->构成超网
- **单播地址**
  - A类地址：网络号（8位） + 主机号（24位）
    - **IP地址全0**表示“**这个**”，**全1**表示**本地广播地址**。当主机不知道所处网络在哪时，用本地广播地址来请求分配IP地址
    - 网络号前1位不可用，为**0**，**网络号字段全0**是保留地址，表示“**本网络**”，**全1**用来做**本地环回测试**，若本机IP地址为98.2.38.1，那么向127.2.38.1这个IP地址发送的所有数据报都会发送到本机
    - **主机号全0**表示该IP地址是**“本主机”所链接到的单个网络地址**，如某主机IP地址位5.6.7.8，则该主机所在网络地址是5.0.0.0；**全1**表示“所有的”，即**主机号全1**表示**该网络上的所有主机**
  - B类地址：网络号（16位） + 主机号（16位）
    - 网络号前2位不能用，为**10**
  - C类地址：网络号（24位） + 主机号（8位）
    - 网络号前3位不可用，为**110**
- **多播地址**
  - D类地址：前面的4位为标识位，为**1110**，**后面的28位**用来表示多播地址
- E类地址：保留，前面4位位标识位，为**1111**

#### 3.1.2 IP地址与硬件地址

- 链路层和物理层使用MAC地址，网络层及以上使用IP地址

#### 3.1.3 地址解析协议ARP

- ARP协议：从**网络层**使用的**IP地址**解析出在**数据链路层**使用的**MAC地址**，使用**MAC帧**通信
  - RARP协议：逆ARP协议，现已经被整合到DHCP协议中
- **ARP高速缓存**：存放一个从**IP地址到硬件地址**的映射表
  - **每个主机**中存有一个ARP高速缓存，里面存有**本局域网**上**各主机和路由器**的IP地址到硬件地址的映射表
  - 该表中每一项有一个**生存时间**，太久未使用的会被删除
- 作用：已知对方的IP地址后，但没有从ARP高速缓存中找到对方的MAC地址，利用ARP协议来获取对方的MAC地址进而进行通信
- 初始化ARP高速缓存
  - 主机A和主机B在**同一局域网**下
    - **ARP请求分组**：主机A在**本局域网**上**广播**ARP请求分组，其中包含**A的IP地址，MAC地址和主机B的IP地址**
    - **ARP响应分组**：主机B收到后，向主机A以**单播**形式发送ARP响应分组，其中包含自己的**MAC地址**，同时在自己的ARP高速缓存中记录下主机A的IP地址和MAC地址的映射
  - 主机A和主机B**跨局域网**
    - 主机A的ARP高速缓存中只存储**主机B的IP地址和其所在的局域网的路由器的MAC地址**的映射

#### 3.1.4 IP数据报

-  ![img](https://bkimg.cdn.bcebos.com/pic/c8177f3e6709c93d464442fd903df8dcd1005401?x-bce-process=image/watermark,image_d2F0ZXIvYmFpa2UxMTY=,g_7,xp_5,yp_5) 
- IP数据报长4个字节共**32位**，分为首部和数据部，同时首部分为固定和可变两部分
- IP数据报**首部**的**固定部分**
  - 版本：占4位，指所使用IP协议的版本
  - 首部长度：占4位，最小是5，最大是15，首部长度的单位是4个字节，当首部长度为5时表示整个首部长度为4×5=20个字节
  - 区分服务：一般不使用
  - 总长度：占16位，表示首部和数据长度之和，数据报最大长度为2的16次方-1，但实际传输时总长度要小于MTU
  - 标识：占16位，IP软件中有一个计数器，每产生一个数据报计数器加一，当数据报需要分片时，同一个数据报的分片在标识处的值都相同，便于在接收端组装分片。
  - 标志：占3位，
    - **最低位记为MF（more fragment）**，MF=1，表示后面还有分片， MF=0，表示该分片是最后一片
    - **中间位记为DF(don't fragment)**，DF=1，表示不可以分片， DF=0，表示可以分片
    - 分片只会在终点重组，但传输过程中可能会出现碎片
  - 片偏移：占13位，分片后某片在原分组中的相对位置，也就是说，**相对于用户数据字段的起点**，该片从何开始，片偏移**以8个字节为偏移单位**，即每个分片的长度一定是8字节的整数倍。
  - 生存时间：占8位，以前记录该数据报的存活时间，现在改为可以经过的路由跳数
  - 协议：占8位，指出此数据报**携带的数据使用何种协议**
  - 首部检验和：占16位，用来检验数据报**首部部分**
- IP数据报**首部**的**可变部分**
  - 很少使用
-  默认路由
   -  在一个小的网络里，所有的主机都通过一个路由和因特网连接时使用。主机和因特网的通信必定通过默认路由

### 3.2 划分子网和构造超网

#### 3.2.1 子网

- A,B类地址中主机号太多导致浪费，所以衍生子网概念，即在主机号中继续分类划出子网，变成3级结构
- IP地址 = 网络号 + 子网号 + 主机号
- 子网掩码：长度32位，网络号和子网号对应位置为1，主机号对应位置为0，子网掩码和IP地址做与运算得出子网号

#### 3.2.2 无分类编址CIDR构成超网

- 采用CIDR编址的IP地址 = **网络前缀 + 主机号**；  如 **128.14.35.7/20**，20表示网络前缀的位数
  - 虽然没有子网，但在实际使用中还是会将当前网络划分出子网
  - 路由表中每一项由 网络前缀 和 下一跳地址 组成
- 最长前缀匹配：在路由表中匹配成功的IP地址可能有许多，每次**选择网络前缀最长**的
- 二叉树线索查找路由表

### 3.3 网际控制报文协议ICMP

- ICMP允许主**机或路由器**报告**差错情况**和提供有关**异常情况**的报告，封装在IP数据报的**数据部分**
- **ICMP差错报告报文** = ICMP的前8个字节 + 收到的需要进行差错报告的IP数据报的首部和数据字段的前8个字节 
  - 终点不可达：**路由器或主机不能交付数据报时**就向源点发送该类型保文
  - 源点抑制：路由器或主机**由于拥塞而丢弃数据报**时向源点发送该类型报文
  - 时间超过：路由器收到**生存时间为0**的数据报时，丢弃之后并向源点发送该类型报文
  - 参数问题：**路由器或目的主机**收到的数据报**首部中有的字段的值不正确**时，丢弃之后并向源点发送该类型报文
  - 改变路由：路由器把该类型报文发送给主机，让主机知道**下次**应将数据报**发送给更合适的路由器**
- **ICMP询问报文** 
  - 回送请求和回答：主机或路由器向一个特定的目标发出询问，收到的主机发送回送回答报文，用来测试目的站是否可达
  - 时间戳请求和回答：请求某个主机或路由器回答当前时间，用来进行时钟同步和测量时间
- ICMP应用举例
  - PING：测试两个主机之间的连通性
    - 命令行输入 ping hostname（主机名或IP地址）
  - tracert (traceroute) ：用来跟踪一个分组从源点到终点的路径

### 3.4 分层次的路由选择协议

- 自治系统：将整个互联网分成许多较小的自治系统，自治系统内部和自治系统之间采用不同的路由选择协议

- 自治系统**内部**：**内部网关协议IGP**
  - **RIP协议**
    - 基于**最短距离向量**的路由选择协议，基于Bellman-Ford算法，采用**传输层的UDP**进行分传输
    - 工作原理
      - 每一个路由器都要维护从他自己到每一个目的网络的**最短距离**记录，即使还存在另外一条更快速的但路由器较多的路由
      - 路由器仅和相邻路由器交换信息，不相邻的路由器不交换信息
      - 交换的信息是路由表，即当前路由器所知道的全部信息
      - 按照固定时间间隔交换路由信息
      - 路由器最终会知道**本自治系统中任何一个网络的最短距离和下一跳路由器的地址**
    - 距离向量算法 P153
      -  RIP报文主要信息= 到目的网络N + 距离是d + 下一跳路由器是X
  - **OSPF协议**
    - 直接用**IP数据报**发送
    - 全名**开放最短路径优先**，基于Dijkstra的最短路径算法SPF，但并不代表其他路由协议不是最短路径优先
    - 工作原理
      - 向本自治系统内的所有相邻路由器发送信息，然后这些路由器收到后再将这个消息发送给和自己相邻的所有路由器，最后自治系统内的**所有路由器都有这个信息的副本**
      - 只有当链路状态发生变化时路由器才会发送此消息
      - 每一个路由器都知道整个自治系统内的结构
    - 区域：自治系统内部分为**主干区域**和**普通区域**。路由器发送信息时可以只局限于区域内
    - 分组类型
      - 问候分组：发现和维持邻站的可达性
      - 数据库描述：向邻站给出自己的链路状态数据库中所有链路状态的摘要信息
      - 链路状态请求：向对方请求发送某些链路状态项目的详细信息
      - 链路状态更新：用洪泛法对全网更新链路状态
      - 链路状态确认：对链路更新分组的确认
- 自治系统**之间**：**外部网关协议EGP**
  - **边界网关协议BGP**
    - 采用**路径向量路由选择协议**
    - 每个自治系统有至少一个路由器做“**BGP发言人**”，自治系统之间通过发言人来进行通信，通信采用**TCP稳定通信**，发言人根据所采用的策略从收到的路由信息中找出到各自治系统的较好路由
    - 发言人除了运行BGP协议外，还需要运行自治系统使用的内部网关协议
    - 报文分类
      - open打开报文：与相邻的另一个BGP发言人建立关系来初始化
      - update升级报文：通告某一路由的信息，列出要撤销的多条路由，**最核心的**
      - keepalive保活报文：发送检测到的差错
      - notification通知报文：请求对等端重新报告

### 3.5 路由器的构成

- 路由器 = 路由选择 + 分组转发

  - 路由选择：核心构件是**路由选择处理机**，它的任务是根据所选定的路由选择协议构造出路由表

  - 分组转发：分组转发 = 交换结构 + 一组输入端口 + 一组输出端口

    - 根据转发表对分组进行处理，决定从某个输入端口进入的分组从哪一个分组输出

  - 转发表和路由表的区别

    - |      | 路由表                     | 转发表                                                       |
      | ---- | -------------------------- | ------------------------------------------------------------ |
      | 信息 | 目的网络到下一跳的映射     | 从路由表得出，每一行包含目的网络到输出端口和某些MAC地址的信息的映射 |
      | 结构 | 对网络拓扑变化的计算最优化 | 是查找过程最优化                                             |
      | 实现 | 软件实现                   | 硬件实现                                                     |

  - 路由器收到的分组

    - 收到RIP或OSPF分组：把该分组交给路由选择部分的路由选择处理机
    - 收到数据分组：按照分组的首部中目的地址查找转发表，找到合适的输出端口

  - **影子副本（端口镜像）**：输入端口的查找和转发功能是路由器的交换功能中最重要的，为了使交换功能分散化，在**每一个输入端口**中都有一份**复制了的转发表**，**路由选择处理机**负责对这些表进行更新，这样可避免转发时卡在某一个路由器上。

    -  为了方便对一个或多个网络接口的流量进行分析，可以通过**配置交换机**来把一个或多个端口（VLAN）的数据**转发到某一个端口**来实现对网络的**监听**，这些流量就可以被一个特殊的设备监控。它对发现和修理故障有很大的帮助。 

  - **链路汇聚** ：是将多个端口聚合在一起形成1个**汇聚组**，以实现出/ 入负荷在各成员端口中的分担，链路聚合后，逻辑链路的带宽增加了大约(n-1)倍，这里，n为聚合的路数。另外，聚合后，**可靠性大大提高**。 

  - 输入和输出端口都有缓冲队列，若分组处理的速率赶不上分组进入输入输出端口处的缓冲队列的速率，那么没有进入队列的分组只能**被丢弃**，出现**分组丢失**
  
  - 交换结构
  
    - 通过存储器：
    - 通过总线：一次只能传送一个分组，跟CPU处理进程原理一致
    - 通过纵横交换结构：N个输入端口，N个输出端口共产生2N个结点，输入端口连接水平总线，输出端口连接垂直总线，分组先进入水平总线然后择机进入垂直总线

### 3.6 IP多播

- 一对多的通信中，每个消息分组只需要发送一次，多播路由将收到的分组**复制成3份**然后向其他多播路由发送，当分组到达局域网时，局域网利用**硬件多播功能**向多播组内的成员发送该分组即可，不需要再次复制。
- 每一个D类地址标志一个多播组，多播数据报是不可靠交付，利用IP数据报传输，多播地址只能用于目的地址，不能用于源地址，多播数据报不产生ICMP差错报文，利用PING测试多播地址不会收到回应
- 在因特网上多播，在局域网上硬件多播
- **硬件多播**
  - 硬件地址和D类多播地址的只是做**对应位置的直接映射**（第10位对应第10位，第9位对应第9位）
  - **D类地址有效位为28位**，**以太网硬件地址**长48位，但只有**23 位可用**，所以多播地址只能用23位，空闲了5位，这导致**多播地址和以太网硬件地址**是**多对一**的局面，所以IP层还需要软件来进行过滤

#### 3.6.1 网际组管理协议IGMP和多播路由选择协议

- IGMP
  - 让连接在本地局域网上的**多播路由器**知道本局域网上**是否有主机**（主机中的进程）参加或退出了某个多播组
  - 工作分为两个阶段
    - **某个主机加入新的多播组时**，该主机应向多播组的多播地址发送一个IGMP报文，声明自己加入该多播组，本地多播路由器收到后还要用多播路由选择协议告知因特网上其他多播路由器
    - 本地多播路由器要周期性地探询本地局域网上的主机，以便了解主机是否还在组里
- 多播路由选择协议
  - 让连接在局域网上的多播路由器和因特网上其他多播路由器**协同工作**，以便把多播数据报用**最小代价传送给所有的组成员**
  - 多播转发树：多播路由选择实际上就是要找出以源主机为根节点的多播转发树，在多播转发树中，每一个多播路由器向树的叶节点方向转发收到的多播数据报，同时不会形成环
  - 不同的多播组对应不同的多播树，同一个多播组中不同的源点也有不同的多播转发树
  - **转发多播数据报的三种方法**
    - 洪泛与减除
      - 适用组**成员接入的局域网是相邻的情况**
      - **反向路径广播RPB策略**：多播路由器采用**洪泛（广播）的方式转发多播数据报**，多播路由器收到一个多播数据报时，先检查数据报是**否从源点经最短路径传来**，若是，就向所有其他方向转发收到的数据报，否则丢弃它。
      - 剪除：多播转发树上的某个路由器发现它的下游树枝已没有该多播组的成员，就把他和下游的树枝一起剪除
    - 隧道技术
      - 适合**多播组的位置在地理上很分散的情况**
      - 两个很远的局域网各自都支持多播，但在这两个局域网的路由器之间很长一段距离的网络上不支持多播，将多播数据报**封装成普通数据报来单播**，然后**通过隧道发送**
    - 基于核心的发现技术
      - 适合多**播组的大小在较大范围内变化**时都适合
      - 每个多播组指定一个**核心路由器**，给出它的**IP单播地址**，给核心路由器创建出对应的**多播组的多播转发树**

### 3.7 虚拟专用网VPN和网络地址转换NAT

- 虚拟专用网VPN
  - 背景
    - IP地址紧缺，一个机构申请到的IP地址数不够用
    - 大多数情况下一个机构内的主机和本机构内其他主机通信
    - 若在一个**机构内**采用**TCP/IP协议通信**，那么本机构可以自行分配IP地址（**本地地址**），而不是使用全球唯一的IP地址（**全球地址**）
    - 因特网中路由器对使用本地地址的报文不予转发
    - 采用本地地址的的网络称为**专用互联网**
    - 母公司和子公司不再同一城市，可以借用因特网来实现**不同专用网之间的通信**，这样的专用网成为**虚拟专用网VPN**，通过因特网传输的报文都需要**加密**
  - 实现
    - 每一个场所至少要有一个路由器具有合法的全球IP地址，该路由器处在**专网和因特网之间**
    - 专用网内部数据报通过该路由器加密传输给另一个专用的路由器，其进行解密
  - 远程接入VPN：流动员工在外地接入虚拟专用网VPN来办公
- 网络地址转换NAT
  - 将专用网内主机的本地地址转换成全球地址，解决专用网内部主机和**因特网上的主机的通信**
  - **NAT路由器**：在专用网连接到因特网的路由器上安装NAT软件，该路由器至少有一个**全球地址**，当NAT路由器有n个全球地址时，专用网内部最多可以有n台主机接入到因特网，专用网内主机轮流使用这些全球地址
  - **NAT地址转换表**： 本地地址 和 全球地址 的映射，在通信时查找该表
  - **NAPT网络地址与端口号转换**：把**传输层的端口号**也利用上，使得**多个专用网内部主机共用一个全球地址**
    - 不同的专用地址被映射到全球地址上的传输层的端口上，一个端口号对应一个本地地址，而不是原来的一个全球地址对应一个本地地址
  - **通信必须由专用网内部主机发起**，因特网上主机不能主动和专用网内主机通信



## 4、传输层

- 运输层为相互通信的应用进程提供逻辑通信
- 端口和套接字的意义
- 无连接的UDP的特点
- 面向连接的TCP的特点
- 在不可靠的网络上实现可靠传输的工作原理，停止等待协议和ARQ协议
- TCP的滑动窗口，流量控制，拥塞控制和连接管理

### 4.1 概述

- IP层实现主机和主机的通信，传输层实现进程和进程之间的通信
- 复用和分用
  - 复用：**发送方**不同的进程都可以使用**同一个运输层协议**传送数据
  - 分用：**接收方**的传输层在剥去报文的首部后能够把这些数据正确**交付目的进程**
- 端口
  - 用来标识主机内不同进程，实现分用
  - 端口号只在本地有用
  - 分类
    - 服务器端使用的端口号：
      - 系统端口号：这些端口号指派给了 TCP/IP 中一些重要的应用程序
      - 登记端口号：需要自己登记
    - 客户端使用的端口号
      - 短暂端口号：仅在客户进程运行时才动态选择，通信结束就被释放

### 4.2 用户数据报协议UDP

- 概述
  - **无连接，不可靠交付，没有拥塞控制，支持1对1, 1对多，多对1，首部开销小**
  - **面向报文**：对应用层传下来的报文，添加首部后就交付网络层；对网络层传上来的报文，去除首部就交付应用层
- UDP报文
  - UDP报文 = UDP首部 + 数据字段
  - 当端口号不正确时接收端会发送一个端口不可达的ICMP差错保文
  - UDP报文长度由应用进程决定
  - 首部：长8个字节，每个部分占2个字节
    - **源端口 + 目的端口 + 长度 + 检验和**
  - 伪首部：长12个字节
    - **计算检验和**时在UDP报文前**临时加上一个伪首部**，把首部和数据部都检验了

### 4.3 传输控制协议TCP

- 概述
  - **面向连接**：进程通信之前先建立连接，通信结束必须释放连接
  - **点对点，可靠交付，全双工通信，流量控制，面向字节流**
  - TCP报文的长度根据**对方给出的窗口值**和**当前网络拥塞程度**决定
  - TCP连接的端点叫套接字socket，如 **socket = 192.3.4.5 : 80**，将**端口号**拼接到IP地址后，每一条TCP连接唯一地被通信两端的两个socket确定

### 4.4 可靠传输的工作原理

- 方法
  - 出现差错时**发送方重传出错的报文**
  - 接收方来不及处理收到的数据时，告诉发送方**降低发送数据的速率**
  - 以下是解绝方案，A: 发送方， B：接收方
- **停止等待协议**：发送完一个分组后停下来，等待对方确认，收到确认后再继续发送下一个分组
  - **无差错情况**：A发送分组给B，B收到分组后向A发送确认，A收到确认后发送下一个分组
  - **分组出现差错**：
    - **B丢弃收到的分组或者什么也不做**，可能是B检测到分组有问题，也可能是传输过程中出错
    - **超时重传**：A 每发送完一个分组后设置一个**超时计时器**，在规定时间内**没有收到确认**后A认定刚才的分组丢失了，**重传**刚才那个分组
      - A会暂时保留已发送的分组的副本，用来重传时使用
      - 分组和确认分组都必须编号，明确收到的确认是哪个分组的
      - 超时计时器设定的**重传时间应比平均往返时间略长**
  - **确认丢失和确认迟到**：
    - 确认丢失和确认迟到都会导致B虽然已经收到分组，但A还会重传，所以B有以下两个行动，称为**自动重传请求ARQ**
    - **丢弃这个重复的分组**：
    - **向A发送确认**：不能因为发送过确认就不再发送确认，否则A可能会不停重传
  - **信道利用率**：采用停止等待协议优点是简单，缺点是信道利用率太低
- **连续ARQ协议**
  - 滑动窗口：发送方维护一个用队列实现的发送窗口，每收到一个确认，队列头出一个队列尾进一个。
  - 累计确认：接收方连续接收到几个分组后，只发送最后一个分组的确认。

### 4.5 TCP报文的首部

- 首部的**前20个字节是固定的**，**后面的4n个字节**是根据需要而增加的
- 源端口和目的端口：分别占2个字节，一个主机确定了IP地址后最多同时和**小于65535**（2^16）个进程通信
- 序号：占4个字节，表示本**报文段所发送数据的第一个字节的序号**。如一报文段的序号字段值是301，携带的数据长100字节，那么最后一个字节的序号是400，下一个报文段的数据序号为401
- 确认号：期望收到对方下一个报文段的第一个数据字节的序号，如B向A发送确认时确认号为401，A收到后就知道刚才那个报文段发送成功了
- 数据偏移：占4位，用来指示TCP首部的长度
- 保留
- 六个控制位
  - **紧急URG**：URG=1时，表示该报文段**优先级很高**，接收端先处理这个报文段，配合**紧急指针字段**使用
  - **确认ACK**：ACK=1时，确认号字段才有效，ACK=0，确认号无效；连接建立后所有传送的报文端都必须把ACK置1
  - **推送PSH**：PSH=1时，接收端收到的报文段PSH=1时会立即将其交给进程，而不是等待缓冲区慢时才上交
  - **复位RST**：RST=1时，表示TCP连接出现差错，需要断开后重新连接；还可以用来拒绝一个非法的报文段或拒绝打开一个连接
  - **同步SYN**：SYN=1时，表示这是一个**请求连接或接受连接的报文**
    - **SYN=1, ACK =0**： 表明这是一个连接请求报文段，A向B发送该保文，请求连接
    - **SYN=1, ACK =1:** 表明这是一个接受连接的报文，B向A发送该保文，同意连接
  - **终止FIN**：FIN=1时，表示发送已经发送完所有报文，要求释放连接
- 窗口：占2个字节，表示**发送方接受窗口的大小**，也就是表明发送方现在还能再接受这么多的字节，这个值时**动态**的
- 检验和：占2个字节，需要在TCP报文段前加伪首部，检验TCP首部和数据部
- 紧急指针：占2个字节，仅在URG=1时游泳，表示本报文段中紧急数据的字节数，即使窗口为0时也可以发送紧急数据
- 选项：最长可达40字节

### 4.6 TCP可靠传输的实现

- 滑动窗口
  - 三个指针P1,P2,P3分别指向已发送但未收到确认，允许发送但尚未发送，不允许发送的数据
  - 接受窗口：接受窗口满了后不再接受
  - 发送窗口：发送窗口满了后发送方不能再发送
- 缓存区：缓存区要大于滑动窗口
  - 接受缓存
  - 发送缓存
- 超时重传时间的选择
  - 自适应算法：TCP保留报文段的往返时间RTT的一个加权平均往返时间RTTs，这个RTTs动态更新
  - 选择确认SACK：解决收到的字节块的序号不连续问题，但需要提前商量好

### 4.7 TCP的流量控制

- 利用滑动窗口实现
  - 目的：让发送方发送不要太快，要让接收方来得及接收
  - 发送方的发送窗口要小于接收方给出的接受窗口的数值，TCP窗口单位是字节，不是报文段
  - 当B向A发送零窗口报文段后B的接受缓存有了空闲空间，然而B向A发送的扩大发送窗口的报文段丢失了，那么A如何解决？
    - TCP为每一个连接设有一个**持续计时器**，连接的某一方收到零窗口通知后就启动该计时器，时间到了后就发送一个**零窗口探测报文段**，对方就在确认这个探测报文段时**给出新的窗口值**
- 必须考虑传输效率
  - TCP控制报文段的发送时机
    - TCP维护一个**最大报文段长度MSS**的变量
    - 发送方的应用进程指明要求发送报文段
    - 发送方的一个计时器期限到了
  - 解决方法：配合使用
    - **Nagle算法**：A先把第一个数据字节发送出去，把后面的字节缓存起来，A收到B的确认后，将后面的字节组成报文段发送出去。同时，当缓存中的数据超过发送窗口的一半时或者达到MSS的长度时，立即组成报文段发送
    - **糊涂窗口综合症**：当B的接收缓存已满，一次读取一个字节，那么发送确认报文时要求A的发送窗口只能为1，那么这样下去发送效率极低，所以提出两个解决方法：
      - 让接收方等待一段时间后，发送确认报文
      - 等到接受缓存已经有一半空闲的空间，发送确认报文

### 4.8 TCP的拥塞控制

- 拥塞：网络中某一资源出现供应不足的情况使得网络性能变坏

- 慢开始和拥塞避免
  - **拥塞窗口cwnd**：**发送方**维持该窗口，并让自己的发送窗口 <= 拥塞窗口
  - **传输轮次**：把cwnd所允许发送的报文段都连续发送出去，并收到了对已发送的最后一个字节的确认所用的时间。**一个传输轮次**所经历的时间就是**往返时间RTT**
  - **慢开始**：cwnd初始为一个最大报文段MSS的数值，**每收到一个新报文段的确认，cwnd增加一个MSS的数值**，一个传输轮次后cwnd就翻倍
  - **慢开始门限ssthresh**：
    - cwnd < ssthresh ： 使用慢方法
    - cwnd > ssthresh：使用拥塞避免算法
    - cwnd = ssthresh：两个方法都可以
  - **拥塞避免算法**：每经过一个传输轮次，cwnd加1，而不是加倍； 
  - 无论什么时候只要发送方判断网络拥塞，把**ssthresh**设置为出现拥塞时的方法窗口值的**一半**，**cwnd重新设置为1**，
  - 先执行慢开始算法，一个传输轮次也就是一个RTT所需时间，拥塞窗口cwnd翻倍，超过门限值ssthresh后，门限值变为原来一半而且cwnd设置为1，然后继续执行慢开始算法，当超过阈值时，执行拥塞避免算法，拥塞窗口cwnd每次加1。就这样循环往复
- 快重传和快恢复
  - 重复确认：接收方一连收到三个重复确认就重发未被确认的报文段
    - A向B发送报文M1,M2,M3,M4，B发送了M1,M2的确认，但M3在发送过程中丢失了，B向A连着发送3次M2的确认来提示A重传M3
  - **快重传**：接收方**每收到一个失序的报文段**就立即发出重复确认，而不是等待自己发送数据时才捎带确认
  - 乘法减小算法：ssthresh减半
  - 加法增大算法：执行**拥塞避免算法**后，使cwnd缓慢变大
  - **快恢复**：当发送方收到三个重复确认时，执行**乘法减小算法**，但不执行慢开始算法，而是把cwnd设置为ssthresh减半后的数值，然后开始执行拥塞避免算法
- 随机早期检测RED

### 4.9 TCP的运输连接管理

- A是客户，B是服务器

- 三次握手---建立连接
  - 最初A,B的TCP进程都处于关闭状态，之后B的TCP服务进程创建传输控制快TCB，并处于LISTEN状态
  - A的TCP进程先创建一个TCB，然后向B发送一个请求报文，同步位SYN=1，序号seq=x
  - B收到A的请求报文后向A发送一个确认报文，同步位SYN=1，确认位ACK=1，序号seq=y，确认号为ack = x+1
  - A收到B的确认报文后向B发送确认确认报文，确认位ACK=1，序号seq=x+1，确认号为y+1
    - A发送确认确认报文的原因：当A刚开始发送的请求报文传输中在某个结点滞留了很久之后才到达B，B收到后向A发送确认报文，但A已经认为请求报文失效了所以不会接受B的确认报文，而没有第三次握手，那么B认为连接成功，A认为连接失败，B会一直等待A发送消息。所以，三次握手就是要让双方都确认连接成功了
- 四次挥手----释放连接
  - A进程向B发送**连接释放报文**段，并停止发送数据，结束位FIN=1，序号seq = u，这个u是前面已传送数据最后一个字节的序号加1
  - B收到A的连接释放报文后向A发送**确认报文**，确认位ACK=1， 序号seq = v，确认号ack=u+1。 
  - 此时A到B的连接断开，A不能在向B发送数据，但B还可以向A发送数据，A也会接收B发来的数据
  - B向A发送**连接释放报文**段，并停止发送数据，结束位FIN=1，**确认位ACK =1**，序号seq = w，**确认号ack=u+1**，这个w是前面已传送数据最后一个字节的序号加1。
    - 此处的确认位ACK=1表示已准备好释放连接了
    - 记得带上确认号，因为A释放连接后没有再向B发送数据，所以确认号没变
  - A收到B的**连接释放报文**后向B**发送确认报文**，确认位ACK=1，序号seq = u+1，确认号ack=w+1
  - A在发送确认报文后还没有彻底释放TCP连接，必须经过**时间等待计时器**设置的时间**2个最长报文段寿命MSL**的时间后A才正式释放连接，一般MSL长2分钟，但可以根据实际情况自行设置。
    - 为什么要等2个MSL的时间？
      - 确保A的确认报文B能收到。当B没有收到确认报文B就会重传连接释放报文，那么在2MSL的之间内A就能收到B重传后的连接释放保文，接着A在发送一次确认报文，并重启时间等待计时器，最后A和B都成功释放连接
      - 防止已失效的连接请求报文段出现在本次连接中。A在发送完最后一个确认报文后，在经过时间2MSL后，就使本连接持续的时间内所产生的报文段都从网络中消失
  
  
  
  -  ![img](https://uploadfiles.nowcoder.com/images/20170821/2889221_1503305073675_395474A8BF8FADD60821E65C19AEE9D2) 
  -  ![img](https://uploadfiles.nowcoder.com/images/20170821/2889221_1503305107204_0C536A60D1D8DDC6892BBFC272F44269)

## 5、应用层

- 域名系统DNS-----从域名解析出IP地址
- 万维网和HTTP协议，以及万维网下两种不同的信息搜索引擎
- 电子邮件传送过程，SMTP协议和POP3协议使用的场合，基于万维网的电子邮件系统的特点
- 动态主机配置协议DHCP的特点
- 网络管理三部分：SNMP，管理信息结构SMI，管理信息库MIB的作用
- 系统调用和应用编程接口的基本概念

### 5.1 域名系统DNS

- 域名：域名不分大小写，一个域名对应的IP地址。有域名树，从顶级到1级，2级等等，从域名的后面往前排列

- 域名系统DNS：一个分布式的数据库系统，一个域名映射一个IP地址，
- 域名服务器：分布式地分布在因特网上，用来解析域名，通常一个**区**一个域名服务器
  - 区 <= 域
- 域名解析过程：应用进程调用解析程序，并成为DNS的一个**客户**，把要解析的域名放在DNS请求报文中，用**UDP**方式发送给**本地域名服务器**，对应的IP地址放在回答报文中，若本地域名服务器不能回答该请求，则它暂时成为DNS中的**另一个客户**，并向其他域名服务器发出查询请求
  - 递归查询
    - 通常是主机向本地域名服务器的查询，但本地域名服务器不知道，本地域名服务器以DNS客户的身份向其他域名服务器查询，直到查询到结果然后返回IP地址
  - 迭代查询
    - 通畅是本地域名服务器向根域名服务器查询，根域名服务器收到后告诉本地域名服务器该向哪个顶级域名服务器查询，然后如此类推，直到查询到结果

### 5.2 文件传送协议FTP

- 概述：
  - 将文件从一台计算机复制到另一台计算机
  - 采用客户服务器方式，服务器进程可同时满足多个客户进程的请求
- 原理
  - 服务器进程分为
    - 主进程：负责接受新的请求
    - 若干丛属进程：负责处理单个请求
  - 客户和服务器之间建立**两个TCP连接**，一个控制连接，一个数据连接，**数据连接在传输完之后会关闭，控制连接保持打开**
    - **服务器使用**的端口：数据连接端口：20，控制连接端口：21

### 5.3 万维网WWW

- 概述
  - 万维网是一个大规模的，联机式的**信息储藏所**，用**链接**的方法方便地实现从因特网**上一个站点访问另一个站点**，简称**Web**
  - 如何标志分布在因特网上的万维网文档？-------**统一资源定位符URL**
  - 用什么样的协议来实现万维网上各种链接？------------**超文本传送协议HTTP**
  - 怎样使不同作者创作不同风格的万维网文档，但还能在各种主机上显示出来且用户都清楚知晓？----------**超文本标记语言HTML**
  - 用户怎么方便地找到需要的信息？------**万维网信息检索系统**
- 统一资源定位符URL
  - URL =  协议 + :// + 主机 ：端口 / 路径
- 超文本传送协议HTTP
  - 概述
    - HTTP协议使用TCP连接，但HTTP协议本身是**无连接**的，**无状态**的
      - 无连接：通信双方在交换HTTP报文之前不需要先建立HTTP连接
      - 无状态：也就是说即使访问同一个域名，每一次访问时都是独立的，都需要握手和挥手
    - HTTP请求分类
  - 访问过程：访问网站www.tsinghua.edu.cn，它指向了清华大学院系设置的页面
    - 浏览器**分析链接指向的页面的URL**
    - 浏览器**向DNS请求解析**www.tsinghua.edu.cn的IP地址
    - 域名系统DNS解析出清华大学服务器的**IP地址为166.111.4.100**
    - 浏览器与服务器**建立TCP连接**
    - 浏览器发出**取文件命令**：GET /chn/yxsz/index.htm
    - 服务器www.tsinghua.edu.cn给出响应，把**文件index.htm**发送给浏览器
    - **释放TCP连接**
    - 浏览器显示“清华大学院系设置”文件index.htm中所有**文本**
  - Cookie
    - 一个小的文本文件，用来存储用户对某个网站访问的信息
    - 使用过程
      - 用户A浏览某个使用Cookie的网站，该网站为A生成一个**唯一的识别码**，并存储在服务器上，将这个识别码放在**HTTP响应报文**中告诉浏览器
      - A通过浏览器继续访问这个网站时**HTTP请求报文都会带上这个标识码**，这样服务器就能知道这是用户A在访问
- 信息检索系统
  - 全文检索搜索引擎：搜索软件在各网站上收集信息，找到一个网站后再链接到另一个网站，建立一个很大的在线数据库供用户查询
  - 分类目录搜索引擎：利用各网站向搜索引擎提交的网站信息中的关键词和网站描述信息，人工审核后将其输入到分类目录的数据库中，供用户查询

### 5.4 电子邮件

- 概述
  - 电子邮件系统的组成：用户代理 + 邮件服务 + 邮件发送协议 + 邮件读取协议
  - 发送和接收邮件都在TCP连接下实现可靠交付
- 用户代理：运行在用户PC中的一个程序，用户与电子系统的接口。至少具有以下四个功能
  - 撰写： 编辑信件的环境
  - 显示：显示邮件上的文字和图像
  - 处理：接发送邮件，根据不同情况对邮件进行处理
  - 通信：邮件发送协议和邮件读取协议来实现从邮件服务器上发送或读取邮件
- 邮件服务器：邮件服务器有大容量邮件邮箱，功能是**发送和接受邮件**，按照客户服务器方式工作
- **简单邮件传送协议SMTP**：在邮件服务器之间传送报文，端口号是25
- **邮件读取协议POP3和IMAP**

### 5.5 动态主机配置协议DHCP

- 概述
  - 为了把协议软件做成通用的，需要把协议软件参数化，给这些参数赋值叫做**协议配置**
  - DHCP用来给需要IP地址的主机配置IP地址，而不需要手动配置
  - DHCP就是自动的协议配置，采用**客户服务器**方式，用**UDP**传输协议的报文
- 实现过程
  - 需要IP地址的主机启动时**向DHCP服务器广播发现保文**，源地址为全0，目的地址为全1，此时该主机成为DHCP客户
  - DHCP服务器收到发现报文，再起**数据库中查找**该计算机的配置信息，若找到就返回找到的信息，若找不到就在**IP地址池**取一个IP地址，装在**回答报文**中发送给主机
- DHCP报文类型
  -  由主机发起Discover、Request、Release、Inform、Decline、
  -  DHCP 服务端向主机发送：Offer、ACK、NAK。
- DHCP中继代理
  - 每一个网络至少有一个DHCP中继代理，它配置了DHCP服务器的IP地址信息，用来减少DHCP服务器的数量
  - 中继代理在收到主机的广播后，以单播的方式向服务器转发这条保文，在收到回答报文后，又将它转发给主机

### 5.6 简单网络管理协议SNMP

- 概述
  - 对网络中软硬件等各种资源进行管理
- 概念：
  - 管理站：整个网络管理系统的核心，管理站的核心是管理程序
  - 管理者：管理站或管理程序都成为管理者，不是人
  - 管理员：用来管理管理者
  - 被管设备：硬件和各种软件，如主机，路由等等，也可称为网络元素
  - 被管对象：一个被管设备中有许多被管对象，可以是某个硬件或某种协议
- SNMP的网络管理 = SNMP本身 + 管理信息结构SMI + 管理信息库MIB  ，三个部分组成
  - SNMP：定义了管理站和网络管理代理程序之间所交换的分组格式
  - SMI：命名对象和定义对象类型的规则
  - MIB：被管理的实体中创建命名对象

### 5.7 套接字Socket

服务器：socket();//socket要求必须绑定socket；

​       bind();//绑定端口和IP，这样我们才知道是那台主机；

​       listen();//监听，看有没有请求连接

​       accept();//接收请求

​       send()||rev();//接收和发送消息

客户端：socket();//socket要求必须绑定socket；

​       connect();//请求连接

​		bind();//需要指定端口来通信时使用，用来绑定端口和IP，一般用connect就够；

## 6、网络安全







## 补充

- 表示计算机二进制的比特序列的**数字信号**是典型的**矩形脉冲信号**。人们将矩形脉冲信号称为**基带信号**。  在数字信道上直接传送基带信号的方法成为基带传输，所以**基带系统是使用数字信号来传输**的。

-  将模拟信号转换为数字信号需要经过 ：采样，量化和编码 

-  IPX:互联网数据包交换协议 ，网络的地址长度为80位。由两部分构成，第一部分是32位的网络号，第二部分是48位的节点号。通常用十六进制数来表示。

- HTTP 常见状态码： 

  - 200 - 请求成功  
  - 301 - 资源（网页等）被永久转移到其它URL 
  -  404 - 请求的资源（网页等）不存在
  -  403 - 服务器收到请求 但拒绝服务
  -  500 - 内部服务器错误 

- 传输时延=数据帧长度/发送速率 。传输时延也叫发送时延

  易混淆的两个概念是**传播**时延和**传输**时延。

  **传输**时延是指一个站点从**开始发送数据帧到数据帧发送完毕**所需要的全部时间，**传播**时延是指**发送端开始发送数据到接收端收到**数据所需要的全部时间。

  传输时延和发送**数据帧大小**有关，而传播时延和**传输距离**相关。 分组交换的数据帧最小，所以传输时延最小

- **属于A类的私有地址：**

  10.0.0.0 – 10.255.255.255

  **属于B类的私有地址：**

  172.16.0.0 – 172.31.255.255（记住是16-31）

  **属于C类的私有地址：**

  192.168.0.0 – 192.168.255.255

-  提高链路速率可以减少数据的 发送时延，也就是传输时延

-  **异步传输模式(ATM)技术**已成为超高速承载大量媒体的最有效手段。信息由固定规格信元承载，每一信元含有一地址以及若干其他控制和用户信息。ATM中异步是指周期性地插入ATM信元，所有含相同地址的信元形成一虚电路。 **ATM**  网络采用**固定长度**的**信元**在**光纤**上传送数据：**信元长度 ： 53 B ，头长度：5B ，数据长度：48B**

- 虚电路： 虚电路是分组交换的两种传输方式中的一种。在通信和网络中，虚电路是由分组交换通信所提供的面向连接的通信服务。在两个节点或应用进程之间建立起一个逻辑上的连接或虚电路后，就可以在两个节点之间依次发送每一个分组，接收端收到分组的顺序必然与发送端的发送顺序一致，因此接收端无须负责在接收分组后重新进行排序 

- 局域网中常用的拓朴结构有：**星型、 环型、 总线型和它们的混合型**

- AM：调幅

  FM：调频

  PM：调相位

-  10BASE5网络结构中，每个网段中的最多结点数目是 100个

-  127.0.0.1是一个保留地址，**专门用于网络软件测试以及本地机进程间通信**，叫做回送地址 

-  HDLC协议是面向比特的，而PPP协议则是面向字节的，HDLC的帧采用开头跟结尾都是01111110作为帧的边界，这样当接收方接收到一串比特的时候可以根据它来判断该帧从哪里开始，到哪里结束，但是，假如在两个标志字段之间的比特串中恰好出现了01111110比特串，那该怎么办呢，HDLC采用零比特填充法，所谓零比特填充法就是每当出现5个1的时候就给它添加一个0进去，而接收方接收到数据时凡出现5个1的时候去掉其后面一个0，这样就能很好地确定帧。 

- 路由权：用于选择最佳路由的信息。

  路由算法修改路由表的基本目的是将最好路由信息添加到路由表中，路由的好坏是由路由算法根据自己获得的路由信息计算出来的。对于每一条路由，路由算法产生一种权值来表示路由的好坏。通常情况下，这种权值越小，该路径越好。

  路由权的计算可能基于路径某单一特性计算，也可能基于路径多种属性进行计算。

- | 操作方式 | 数据位置 | 明文密文 | 数据安全 | 长度限制         | 应用场景 |
  | -------- | -------- | -------- | -------- | ---------------- | -------- |
  | GET      | HTTP包头 | 明文     | 不安全   | 长度较小         | 查询数据 |
  | POST     | HTTP正文 | 可明可密 | 安全     | 支持较大数据传输 | 修改数据 |
  
- 采用非屏蔽双绞线双绞线的最大优点是连接方便、可靠、扩展灵活，对**促进网络结构化布线技术**的发展起到关键的作用。基于非屏蔽双绞线的以太网结构简单、造价低、组网方便、易于维护，目前流行的组网方法。

  使用双绞线组网符合**10BASE-T**标准.

- 集线器只起信号发达和转发的作用，不能隔离冲突域和广播域，交换机能够隔离冲突域 路由器能够隔离广播域 

  - | ARP        | MAC帧 |
    | ---------- | ----- |
    | ICMP       | IP    |
    | RIP        | UDP   |
    | OSPF       | IP    |
    | BGP        | TCP   |
    | IGMP       | IP    |
    | DNS        | UDP   |
    | FTP        | TCP   |
    | TFTP       | UDP   |
    | HTTP       | TCP   |
    | Telent     | TCP   |
    | SMTP       | TCP   |
    | POP3, IMAP | TCP   |
  | DHCP       | UDP   |
    
    - DNS：在DNS之间通信用TCP

  -

-  单模传输距离远，不会发生色散，质量可靠，通常使用激光作为光源，贵。多模传输带宽大，使用便宜的led，近距离传输 

-  [ADSL](http://baike.baidu.com/item/ADSL) 技术是一种不对称数字用户线实现**宽带接入**互连网的技术，ADSL作为一种**传输层**的技术，充分利用现有的铜线资源，在一对[双绞线](http://baike.baidu.com/item/双绞线/487416) 上提供上行640kbps下行8Mbps的[带宽](http://baike.baidu.com/item/带宽) ，从而克服了传统用户在"[最后一公里](http://baike.baidu.com/item/最后一公里/4818117) "的"瓶颈"，实现了真正意义上的宽带接。 

-  **双绞线**有一个“无法逾越”的“**100米”传输距离**。无论是10M传输速率的三类双绞线，还是100M传输速率的五类双绞线，甚至1000M传输速率的六类双绞线，最远有效传输距离为100米。 

- 物理层：

   	中继器，集线器，双绞线 

   数据链路层： 

   	网桥，以太网交换机，网卡（一半物理层，一半数据链路层） 

   网络层： 

  ​	 路由器，三层交换机 

   传输层： 

  ​	 四层交换机（常用作负载均衡），网关：对高层协议（包括传输层及更高层次）进行转换的网间连接器

- 路由器内存分类：

  ROM：    只读内存（不能修改其存放的代码），主要用于**系统初始化**；

  FLASH：  闪存，可读可写，存放着当前使用中的**IOS（互联网操作系统），**若容量足够大，甚至可以存放多个操作系统；

  NVRAM：  非易失性(Nonvolatile)RAM，可读可写，**仅保存启动配置文件**，通常大小为32KB~128KB，速度快，成本高；

  RAM：    随机存储器，可读可写，但存储内容在系统重启、关机后将被清除（上两个都可以保存），运行速度高于前三个；RAM运行时，包含**路由表项目，ARP缓冲项目，日志项目**，**队列中排队等待发送的分组**；除此之外，还包括运行配置文件（Running-config）、正在执行的代码、IOS操作系统程序和一些临时数据信息。

-  **会话跟踪常用的4种方法**：**URL重写，隐藏表单域，cookie,sesion,**

  - URL重写技术就是在URL结尾添加一个附加数据以标识该会话，把会话ID通过URL的信息传递过去，以便在服务端进行识别不同的用户，

  - 隐藏表单域：将会话ID添加到HTML表单元素中提交到服务器，此表单不再客户端显示，

  - cookie,Cookie是Web服务器发送给客户端的一小段信息，客户端请求时可以读取该信息发送到服务器端，进而进行用户的识别。对于客户端的每次请求，服务器都会将Cookie发送到客户端,在客户端可以进行保存,以便下次使用。 

  - session: 在服务器端会创建一个session对象，产生一个sessionID来标识这个session对象，然后将这个sessionID放入到Cookie中发送到客户端，下一次访问时，sessionID会发送到服务器，在服务器端进行识别不同的用户 , Session是依赖Cookie的，如果Cookie被禁用，那么session也将失效  

    -

- DCE(数据通信设备)，具有一定的数据处理能力和数据收发能力的设备，由DTE提供或接收数据。常见的DCE设备有：数据通信设备或电路连接设备,如[调制解调器](https://baike.baidu.com/item/调制解调器)MODEM，连接DTE设备的通信设备。

   DTE是数据终端设备，一般有路由器和终端主机，DCE是数据通讯设备，一般有广域网交换机和MODEM 

-  **调制解调器**，是调制器和解调器的缩写 ，一种[计算机](https://baike.baidu.com/item/计算机)硬件 [1] ，它能把计算机的[数字信号](https://baike.baidu.com/item/数字信号/915663)翻译成可沿普通[电话线](https://baike.baidu.com/item/电话线/3133982)传送的[模拟信号](https://baike.baidu.com/item/模拟信号/706796)，而这些模拟信号又可被线路另一端的另一个调制解调器接收，并译成计算机可懂的语言。这一简单过程完成了两台计算机间的通信。 

-  在GBN协议中，允许发送方发送多个分组（当有多个分组可用时）而不需等待确认，但它也受限于在流水线中未确认的分组数不能超过某个最大允许数N;

  **SR协议(选择重传协议)**在GBN协议的基础上进行了改进，它通过让发送方仅重传那些它怀疑在接收方出错（即丢失或受损）的分组而避免了不必要的重传。**选择重传协议只重传真正丢失的分组.** 

## 补充2

- 数据链路层一般都提供3种基本服务，即无确认的无连接服务、有确认的无连接服务、有确认 的面向连接的服务。有连接那么务必确认

-  利用**集线器**连接的局域网叫**共享式局域网**，利用**交换机**连接的局域网叫**交换式局域网**。 
  - 共享式局域网： 共用一个信道，而一个信道在某一时刻只充许一个用户占用，所以大量主机或路由的经常处于监测等待状态 
  - 交换时局域网： 交换机供给每个用户专用的信息通道，除非两个源端口企图将信息同时发往同一目的端口，否则各个源端口与各自的目的端口之间可同时进行通信而不发生冲突。 
  -  交换机只是在**工作方式上**与集线器**不同**，其它的连接方式、速度选择等则与集线器基本相同 
  
-  在TCP/IP网络中，为各种公共服务保留的端口范围是 1--1023，临时端口是 1024~5000，5000之后为其他服务器预留

-  LAN 参考模型可分为物理层，MAC层，LLC层

-  OUI（Organizational Unique Identifier）：MAC 地址中的前面 6 个 16 进制位

-  互联网的主要硬件设备有中继器、网桥和路由器，刚好是物理层，链路层，网络层

- 集线器不隔离冲突域，广播域； 

  网桥隔离冲突域，不隔离广播域；交换机如果不设置VLAN，那么和网桥一样； 

  路由器隔离冲突域，隔离广播域

-  路由器的每一个接口都有一个不同网络号的 IP 地址。 **两个路由器直接相连**的接口处，可指明也可**不指明 IP 地址** 

-  典型的局域网交换机允许 10Mb/s和 100Mb/s 两种网卡共存，它采用的技术是 10/100Mb/s的 自动侦测数据量大小，大的选100，小的选10 

- **数据链路层层**：差错控制

  **网络层**：网络互连、路由选择、拥塞控制，通过寻址建立节点间连接

  - 网络层协议能补偿数据发送、传输以及接收的设备能力的不平衡性。分段和重组是指当数据从一个能处理较大数据单元的网络段传送到仅能处理较小数据单元的网络段时，网络层对数据包进行分段和重组，减小数据单元的大小）

  **传输层**：流量控制（TCP）
  
-  [传输媒体](http://www.so.com/s?q=传输媒体&ie=utf-8&src=wenda_link) 并不是 [物理层](http://www.so.com/s?q=物理层&ie=utf-8&src=wenda_link) 。传输媒体在物理层的下面。 

- **MPLS(Multiprotocol Label Switching,多协议标记交换. ) VPN** 

  是在网络路由和交换设备上应用MPLS技术.采用路由隔离、地址隔离等多种手段提供了抗攻击和标记欺骗的手段，在MPLS VPN传递数据，只是标记了端点路由，**对数据本身并不提供加密的防护手段。**因此MPLS VPN的安全性一般。

  **IPSEC(Internet Protocol Security) VPN** 是完全基于INTERNET构建的

  IPSEC VPN为了实现在Internet上安全的传递数据，采用了对称密钥、非对称密钥以及摘要算法等多种加密算法，通过身份认证、数据加密、数据完整性校验等多种方式保证接入的安全，保证的数据的私密性。

- **PAP**：密码口令验证协议，全称：Password Authentication Protocol。PAP是两次握手认证协议，在链路首次初始化时，被认证端首先发起认证请求，向认证端发送用户名和密码信息进行身份认证。密码口令以明文发送，所以安全性较低。

  **CHAP**：挑战握手认证协议，全称：Challenge Handshake Authentication Protocol。CHAP通过三次握手验证被认证端的身份，在初始链路建立时完成，为了提高安全性，在链路建立之后周期性进行验证。CHAP比PAP更安全，因为CHAP不在线路上发送明文，而是发送经过MD5过的随机数序列。

-  **Hosts是一个没有扩展名的系统文件，可以用记事本等工具打开，其作用就是将一些常用的网址域名与其对应的IP地址建立一个关联“数据库”** 

- 局域网中目前广泛采用两种介质访问控制策略，第一种是**争用型介质访问控制**，又称随机型介质访问控制，如CSMA/CD；第二种是**确定型介质访问控制**，又称有序的介质访问控制，如Token(令牌)方式，采用循环访问技术；在无线局域网中，介质访问控制策略工作方式为**DCF(分布控制**)和**PCF(中心控制)**，分别采用分布式和集中式访问技术

-  令牌总线媒体访问控制方法的标准是 IEEE802.4

- 当**发送窗口>1 ,接收窗口=1**时，为**连续重发协议，准确而言应为后退N帧协议**。

  当**发送窗口=1,接收窗口=1**时，为**停止等待协议。**因为发送方需要判断每个发送的帧是新发送的帧还是超时重传的帧，故给每个帧前都加一个序号，由于**停止等待协议中只有当一个帧发送确认后才能发送下一个**，所以用1个比特来编号即可。

  当**发送窗口>1,接收窗口>1**时，为**选择重发协议**。当接收方发现某个帧出错后（可能未按序到达），它将后面到达的正确的帧放入接收缓冲区中，同时要求发送方重传出错的帧（对按序到达的最大序号进行确认，当发送方收到重复确认了就知道出错了），当重传的帧到达后，将缓冲区中按序一并发送给高层。

-  An ARP query packet is encapsulated in a link-layer broadcast frame

  - encapsulated ： 封装；   link-layer ：链路层；  frame : 帧

- **127.0.0.1是回送地址，可以测试本地TCP/IP协议是否可用；**

  **10.0.0.1是内部地址，与172.15.\*.\*-172.31.\*.\*   192.168.\*.\*一样，内部网用的地址，不会出现在公网Internet上；**

  **250.0.0.1百度查询，当时分配IP地址时，留了一部分做实验用。**

  **三者的共同点都是不会出现在Internet上，都是比较特殊的那一部分IP地址。**
  
- 双绞线的最大传输距离为100m。 如果要加大传输距离，在两段双绞线之间可安装中继器，最多可安装4个中继器。 同轴电缆的最大传输距离也小于1000米

- 高端的电信级路由器，可以在一个物理端口上设置划分出虚接口（子接口），并为每一个子接口配置IP地址和路由策略

- **10BASE-T的物理拓扑是星型结构，但是逻辑拓扑却是总线型。**

- 局域网参考模型把数据链路层划分为两个子层：逻辑链路控制（LLC）子层和介质访问控制（MAC）子层

-  传输时1K=1000，存储时1K=1024；1kb/s = 1000b/s ;电信运行商的流量包，1G=1024M，1M=1024k; 
